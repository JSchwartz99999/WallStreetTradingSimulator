<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wall Street Trading Simulator</title>
    <meta name="description" content="A realistic stock trading simulator with live market data, portfolio management, and trading features">
    <meta name="author" content="JSchwartz">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); min-height: 100vh; }
        .card { background: rgba(31, 41, 55, 0.95); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 12px; backdrop-filter: blur(10px); }
        .ticker-scroll { animation: scroll 30s linear infinite; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .glow-green { box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
        .glow-red { box-shadow: 0 0 20px rgba(239, 68, 68, 0.3); }
        .tab-active { background: rgba(16, 185, 129, 0.2); border-bottom: 2px solid #10B981; }
        .asset-selected { border: 2px solid #10B981 !important; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="text-gray-100 p-4">
    <div id="app" class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="card p-4 mb-4">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl font-bold text-green-400">Wall Street Trading Simulator</h1>
                    <span class="flex items-center gap-2 text-red-400 text-sm">
                        <span class="w-2 h-2 bg-red-500 rounded-full pulse"></span>
                        LIVE MARKET
                    </span>
                </div>
                <div class="flex items-center gap-6">
                    <div class="text-right">
                        <div class="text-sm text-gray-400">Portfolio Value</div>
                        <div id="portfolioValue" class="text-xl font-bold text-green-400">$100,000.00</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-400">Cash Balance</div>
                        <div id="cashBalance" class="text-xl font-bold text-green-400">$100,000.00</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-400">Day's P/L</div>
                        <div id="dayPL" class="text-xl font-bold text-green-400">$0.00</div>
                    </div>
                    <button onclick="resetPortfolio()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-colors">
                        Reset
                    </button>
                </div>
            </div>
        </header>

        <!-- Market Ticker -->
        <div class="card p-3 mb-4 overflow-hidden">
            <div id="tickerContainer" class="flex gap-8 ticker-scroll whitespace-nowrap">
                <!-- Ticker items will be inserted here -->
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-12 gap-4 mb-4">
            <!-- Market Overview -->
            <div class="col-span-12 lg:col-span-6 card p-4">
                <h2 class="text-lg font-semibold mb-4 text-gray-200">Market Overview</h2>
                <div class="flex gap-2 mb-4">
                    <button onclick="filterAssets('all')" class="asset-filter px-3 py-1 rounded text-sm bg-green-600">All</button>
                    <button onclick="filterAssets('stocks')" class="asset-filter px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600">Stocks</button>
                    <button onclick="filterAssets('commodities')" class="asset-filter px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600">Commodities</button>
                    <button onclick="filterAssets('bonds')" class="asset-filter px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600">Bonds</button>
                </div>
                <div id="marketOverview" class="grid grid-cols-2 gap-3 max-h-80 overflow-y-auto">
                    <!-- Asset cards will be inserted here -->
                </div>
            </div>

            <!-- Trading Interface -->
            <div class="col-span-12 lg:col-span-3 card p-4">
                <h2 class="text-lg font-semibold mb-4 text-gray-200">Trade</h2>
                <div id="selectedAssetInfo" class="mb-4 p-3 bg-gray-700 rounded-lg">
                    <div class="text-sm text-gray-400">Selected Asset</div>
                    <div id="selectedSymbol" class="text-xl font-bold text-green-400">AAPL</div>
                    <div id="selectedPrice" class="text-lg">$182.30</div>
                </div>

                <div class="mb-4">
                    <div class="flex gap-2 mb-3">
                        <button onclick="setOrderType('market')" id="marketOrderBtn" class="flex-1 py-2 rounded text-sm bg-green-600">Market</button>
                        <button onclick="setOrderType('limit')" id="limitOrderBtn" class="flex-1 py-2 rounded text-sm bg-gray-700 hover:bg-gray-600">Limit</button>
                    </div>

                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Quantity</label>
                            <input type="number" id="quantity" min="1" value="1" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-green-500 focus:outline-none">
                        </div>
                        <div id="limitPriceContainer" class="hidden">
                            <label class="block text-sm text-gray-400 mb-1">Limit Price</label>
                            <input type="number" id="limitPrice" step="0.01" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-green-500 focus:outline-none">
                        </div>
                        <div class="text-sm text-gray-400">
                            Estimated Total: <span id="estimatedTotal" class="text-white font-semibold">$182.30</span>
                        </div>
                        <div class="text-sm text-gray-400">
                            Max Shares: <span id="maxShares" class="text-white">548</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="executeTrade('buy')" class="py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition-colors glow-green">
                        BUY
                    </button>
                    <button onclick="executeTrade('sell')" class="py-3 bg-red-600 hover:bg-red-700 rounded-lg font-semibold transition-colors glow-red">
                        SELL
                    </button>
                </div>
            </div>

            <!-- Market Status -->
            <div class="col-span-12 lg:col-span-3 card p-4">
                <h2 class="text-lg font-semibold mb-4 text-gray-200">Market Status</h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Market Hours</span>
                        <span id="marketHours" class="text-green-400 font-semibold">Open</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">S&P 500</span>
                        <span id="sp500" class="text-green-400">+1.24%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">NASDAQ</span>
                        <span id="nasdaq" class="text-green-400">+1.56%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">DOW</span>
                        <span id="dow" class="text-red-400">-0.32%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">VIX</span>
                        <span id="vix" class="text-yellow-400">16.42</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Volume</span>
                        <span id="volume" class="text-gray-200">2.4B</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Analysis Section -->
        <div class="grid grid-cols-12 gap-4 mb-4">
            <!-- Price Chart -->
            <div class="col-span-12 lg:col-span-6 card p-4">
                <div class="flex gap-2 mb-4">
                    <button onclick="setChartTab('chart')" id="chartTabBtn" class="tab-active px-4 py-2 rounded-t text-sm">Price Chart</button>
                    <button onclick="setChartTab('orderbook')" id="orderbookTabBtn" class="px-4 py-2 rounded-t text-sm bg-gray-700 hover:bg-gray-600">Order Book</button>
                    <button onclick="setChartTab('news')" id="newsTabBtn" class="px-4 py-2 rounded-t text-sm bg-gray-700 hover:bg-gray-600">Market News</button>
                </div>

                <div id="chartContent">
                    <div class="flex gap-2 mb-4">
                        <button onclick="setTimeframe('1D')" class="timeframe-btn px-3 py-1 rounded text-sm bg-green-600">1D</button>
                        <button onclick="setTimeframe('5D')" class="timeframe-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600">5D</button>
                        <button onclick="setTimeframe('1M')" class="timeframe-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600">1M</button>
                        <button onclick="setTimeframe('3M')" class="timeframe-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600">3M</button>
                        <button onclick="setTimeframe('1Y')" class="timeframe-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600">1Y</button>
                    </div>
                    <canvas id="priceChart" height="250"></canvas>
                    <canvas id="volumeChart" height="80" class="mt-2"></canvas>
                </div>

                <div id="orderbookContent" class="hidden">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h3 class="text-red-400 font-semibold mb-2">Bids (Buy Orders)</h3>
                            <div id="bids" class="space-y-1 text-sm">
                                <!-- Bids will be inserted here -->
                            </div>
                        </div>
                        <div>
                            <h3 class="text-green-400 font-semibold mb-2">Asks (Sell Orders)</h3>
                            <div id="asks" class="space-y-1 text-sm">
                                <!-- Asks will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div id="newsContent" class="hidden space-y-3">
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <div class="text-green-400 font-semibold">Tech Stocks Rally on AI Optimism</div>
                        <div class="text-sm text-gray-400 mt-1">Major technology companies see gains as investors remain bullish on artificial intelligence developments.</div>
                        <div class="text-xs text-gray-500 mt-2">2 hours ago</div>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <div class="text-red-400 font-semibold">Fed Signals Potential Rate Changes</div>
                        <div class="text-sm text-gray-400 mt-1">Federal Reserve officials hint at possible adjustments to monetary policy in upcoming meetings.</div>
                        <div class="text-xs text-gray-500 mt-2">4 hours ago</div>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <div class="text-green-400 font-semibold">Energy Sector Shows Strong Performance</div>
                        <div class="text-sm text-gray-400 mt-1">Oil prices stabilize as global demand outlook improves, boosting energy stocks.</div>
                        <div class="text-xs text-gray-500 mt-2">6 hours ago</div>
                    </div>
                </div>
            </div>

            <!-- Portfolio -->
            <div class="col-span-12 lg:col-span-3 card p-4">
                <h2 class="text-lg font-semibold mb-4 text-gray-200">Portfolio</h2>
                <div class="mb-4 p-3 bg-gray-700 rounded-lg">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Total Value</span>
                        <span id="totalValue" class="text-green-400 font-bold">$100,000.00</span>
                    </div>
                    <div class="flex justify-between mt-2">
                        <span class="text-gray-400">Total P/L</span>
                        <span id="totalPL" class="text-green-400">$0.00 (0.00%)</span>
                    </div>
                </div>
                <div id="positions" class="space-y-2 max-h-60 overflow-y-auto">
                    <div class="text-center text-gray-500 py-4">No positions yet</div>
                </div>
            </div>

            <!-- Trade History -->
            <div class="col-span-12 lg:col-span-3 card p-4">
                <h2 class="text-lg font-semibold mb-4 text-gray-200">Trade History</h2>
                <div id="tradeHistory" class="space-y-2 max-h-80 overflow-y-auto">
                    <div class="text-center text-gray-500 py-4">No trades yet</div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="card p-4 text-center text-gray-400 text-sm">
            <p>Wall Street Trading Simulator - For Educational Purposes Only</p>
            <p class="mt-1">Data is simulated and does not represent real market conditions</p>
        </footer>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <span id="toastMessage"></span>
    </div>

    <script>
        // ==================== STATE MANAGEMENT ====================
        const STORAGE_KEY = 'wallStreetSimulator';

        const defaultState = {
            cashBalance: 100000,
            positions: {},
            tradeHistory: [],
            settings: {
                orderType: 'market',
                selectedAsset: 'AAPL',
                timeframe: '1D',
                chartTab: 'chart',
                assetFilter: 'all'
            }
        };

        let state = loadState();
        let priceChart = null;
        let volumeChart = null;

        // Asset data
        const assets = {
            // Stocks
            AAPL: { name: 'Apple Inc.', type: 'stocks', price: 182.30, change: 2.45 },
            MSFT: { name: 'Microsoft', type: 'stocks', price: 378.50, change: -1.20 },
            TSLA: { name: 'Tesla Inc.', type: 'stocks', price: 245.80, change: 5.30 },
            GOOGL: { name: 'Alphabet', type: 'stocks', price: 141.20, change: 1.80 },
            AMZN: { name: 'Amazon', type: 'stocks', price: 178.90, change: -0.65 },
            META: { name: 'Meta Platforms', type: 'stocks', price: 505.75, change: 8.20 },
            NVDA: { name: 'NVIDIA', type: 'stocks', price: 875.40, change: 15.60 },
            JPM: { name: 'JPMorgan Chase', type: 'stocks', price: 198.30, change: -2.10 },
            // Commodities
            GC: { name: 'Gold', type: 'commodities', price: 2045.50, change: 12.30 },
            CL: { name: 'Crude Oil', type: 'commodities', price: 78.45, change: -0.85 },
            SI: { name: 'Silver', type: 'commodities', price: 23.80, change: 0.45 },
            // Bonds
            TNX: { name: '10Y Treasury', type: 'bonds', price: 4.25, change: 0.02 },
            TYX: { name: '30Y Treasury', type: 'bonds', price: 4.42, change: -0.01 }
        };

        // Ticker symbols for the scrolling ticker
        const tickerSymbols = ['SPY', 'QQQ', 'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'META', 'NVDA', 'JPM'];

        // ==================== LOCAL STORAGE ====================
        function loadState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    return { ...defaultState, ...parsed };
                }
            } catch (e) {
                console.error('Error loading state:', e);
            }
            return { ...defaultState };
        }

        function saveState() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (e) {
                console.error('Error saving state:', e);
            }
        }

        function resetPortfolio() {
            if (confirm('Are you sure you want to reset your portfolio? This will clear all positions and trade history.')) {
                state = { ...defaultState };
                saveState();
                updateUI();
                showToast('Portfolio reset successfully', 'success');
            }
        }

        // ==================== UI UPDATES ====================
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }

        function formatPercent(value) {
            const sign = value >= 0 ? '+' : '';
            return `${sign}${value.toFixed(2)}%`;
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 z-50 ${
                type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
            }`;
            toastMessage.textContent = message;

            toast.classList.remove('translate-y-20', 'opacity-0');

            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        function updateHeader() {
            const portfolioValue = calculatePortfolioValue();
            const cashBalance = state.cashBalance;
            const totalValue = portfolioValue + cashBalance;
            const initialValue = 100000;
            const dayPL = totalValue - initialValue;

            document.getElementById('portfolioValue').textContent = formatCurrency(totalValue);
            document.getElementById('portfolioValue').className = `text-xl font-bold ${totalValue >= initialValue ? 'text-green-400' : 'text-red-400'}`;

            document.getElementById('cashBalance').textContent = formatCurrency(cashBalance);

            document.getElementById('dayPL').textContent = formatCurrency(dayPL);
            document.getElementById('dayPL').className = `text-xl font-bold ${dayPL >= 0 ? 'text-green-400' : 'text-red-400'}`;
        }

        function updateTicker() {
            const container = document.getElementById('tickerContainer');
            let html = '';

            tickerSymbols.forEach(symbol => {
                const asset = assets[symbol] || { price: Math.random() * 500 + 100, change: (Math.random() - 0.5) * 10 };
                const isPositive = asset.change >= 0;
                const changePercent = ((asset.change / asset.price) * 100).toFixed(2);

                html += `
                    <div class="flex items-center gap-3">
                        <span class="font-semibold text-white">${symbol}</span>
                        <span class="text-gray-300">${formatCurrency(asset.price)}</span>
                        <span class="${isPositive ? 'text-green-400' : 'text-red-400'} flex items-center gap-1">
                            ${isPositive ? '▲' : '▼'} ${formatPercent(parseFloat(changePercent))}
                        </span>
                    </div>
                `;
            });

            // Duplicate for seamless scroll
            container.innerHTML = html + html;
        }

        function updateMarketOverview() {
            const container = document.getElementById('marketOverview');
            const filter = state.settings.assetFilter;
            let html = '';

            Object.entries(assets).forEach(([symbol, asset]) => {
                if (filter !== 'all' && asset.type !== filter) return;

                const isPositive = asset.change >= 0;
                const changePercent = ((asset.change / asset.price) * 100).toFixed(2);
                const isSelected = state.settings.selectedAsset === symbol;
                const typeColor = asset.type === 'stocks' ? 'blue' : asset.type === 'commodities' ? 'yellow' : 'purple';

                html += `
                    <div onclick="selectAsset('${symbol}')"
                         class="p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors ${isSelected ? 'asset-selected' : ''} border border-transparent">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-semibold text-white">${symbol}</span>
                            <span class="text-xs px-2 py-0.5 rounded bg-${typeColor}-900 text-${typeColor}-300">${asset.type}</span>
                        </div>
                        <div class="text-lg font-bold text-white">${formatCurrency(asset.price)}</div>
                        <div class="${isPositive ? 'text-green-400' : 'text-red-400'} text-sm flex items-center gap-1">
                            ${isPositive ? '▲' : '▼'} ${formatCurrency(Math.abs(asset.change))} (${formatPercent(parseFloat(changePercent))})
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateTradingInterface() {
            const symbol = state.settings.selectedAsset;
            const asset = assets[symbol];

            document.getElementById('selectedSymbol').textContent = symbol;
            document.getElementById('selectedPrice').textContent = formatCurrency(asset.price);

            updateEstimatedTotal();
            updateMaxShares();
        }

        function updateEstimatedTotal() {
            const symbol = state.settings.selectedAsset;
            const asset = assets[symbol];
            const quantity = parseInt(document.getElementById('quantity').value) || 0;
            const orderType = state.settings.orderType;

            let price = asset.price;
            if (orderType === 'limit') {
                price = parseFloat(document.getElementById('limitPrice').value) || asset.price;
            }

            document.getElementById('estimatedTotal').textContent = formatCurrency(quantity * price);
        }

        function updateMaxShares() {
            const symbol = state.settings.selectedAsset;
            const asset = assets[symbol];
            const maxShares = Math.floor(state.cashBalance / asset.price);
            document.getElementById('maxShares').textContent = maxShares.toLocaleString();
        }

        function updatePositions() {
            const container = document.getElementById('positions');
            const positions = state.positions;

            if (Object.keys(positions).length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">No positions yet</div>';
                return;
            }

            let html = '';
            Object.entries(positions).forEach(([symbol, position]) => {
                const asset = assets[symbol];
                const currentValue = position.quantity * asset.price;
                const costBasis = position.quantity * position.avgPrice;
                const pl = currentValue - costBasis;
                const plPercent = ((pl / costBasis) * 100).toFixed(2);
                const isPositive = pl >= 0;

                html += `
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="font-semibold text-white">${symbol}</span>
                                <span class="text-gray-400 text-sm ml-2">${position.quantity} shares</span>
                            </div>
                            <span class="text-white font-bold">${formatCurrency(currentValue)}</span>
                        </div>
                        <div class="flex justify-between items-center mt-1 text-sm">
                            <span class="text-gray-400">Avg: ${formatCurrency(position.avgPrice)}</span>
                            <span class="${isPositive ? 'text-green-400' : 'text-red-400'} flex items-center gap-1">
                                ${isPositive ? '▲' : '▼'} ${formatCurrency(Math.abs(pl))} (${formatPercent(parseFloat(plPercent))})
                            </span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Update portfolio totals
            const totalValue = calculatePortfolioValue() + state.cashBalance;
            const totalPL = totalValue - 100000;
            const totalPLPercent = ((totalPL / 100000) * 100).toFixed(2);

            document.getElementById('totalValue').textContent = formatCurrency(totalValue);
            document.getElementById('totalPL').textContent = `${formatCurrency(totalPL)} (${formatPercent(parseFloat(totalPLPercent))})`;
            document.getElementById('totalPL').className = totalPL >= 0 ? 'text-green-400' : 'text-red-400';
        }

        function updateTradeHistory() {
            const container = document.getElementById('tradeHistory');
            const history = state.tradeHistory;

            if (history.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">No trades yet</div>';
                return;
            }

            let html = '';
            history.slice(0, 20).forEach(trade => {
                const isBuy = trade.type === 'buy';

                html += `
                    <div class="p-2 bg-gray-700 rounded text-sm">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold ${isBuy ? 'text-green-400' : 'text-red-400'}">${trade.type.toUpperCase()}</span>
                            <span class="text-gray-400 text-xs">${trade.time}</span>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-white">${trade.symbol} x${trade.quantity}</span>
                            <span class="text-gray-300">@ ${formatCurrency(trade.price)}</span>
                        </div>
                        <div class="text-right text-gray-400 text-xs mt-1">
                            Total: ${formatCurrency(trade.total)}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateOrderBook() {
            const symbol = state.settings.selectedAsset;
            const asset = assets[symbol];
            const basePrice = asset.price;

            let bidsHtml = '';
            let asksHtml = '';

            for (let i = 0; i < 8; i++) {
                const bidPrice = basePrice - (i + 1) * 0.05;
                const bidSize = Math.floor(Math.random() * 500) + 100;
                bidsHtml += `
                    <div class="flex justify-between text-red-400">
                        <span>${formatCurrency(bidPrice)}</span>
                        <span>${bidSize}</span>
                    </div>
                `;

                const askPrice = basePrice + (i + 1) * 0.05;
                const askSize = Math.floor(Math.random() * 500) + 100;
                asksHtml += `
                    <div class="flex justify-between text-green-400">
                        <span>${formatCurrency(askPrice)}</span>
                        <span>${askSize}</span>
                    </div>
                `;
            }

            document.getElementById('bids').innerHTML = bidsHtml;
            document.getElementById('asks').innerHTML = asksHtml;
        }

        function calculatePortfolioValue() {
            let total = 0;
            Object.entries(state.positions).forEach(([symbol, position]) => {
                const asset = assets[symbol];
                total += position.quantity * asset.price;
            });
            return total;
        }

        // ==================== CHART FUNCTIONS ====================
        function initCharts() {
            const priceCtx = document.getElementById('priceChart').getContext('2d');
            const volumeCtx = document.getElementById('volumeChart').getContext('2d');

            const { priceData, volumeData, labels } = generateChartData();

            priceChart = new Chart(priceCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Price',
                        data: priceData,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(75, 85, 99, 0.3)' }, ticks: { color: '#9CA3AF' } },
                        y: { grid: { color: 'rgba(75, 85, 99, 0.3)' }, ticks: { color: '#9CA3AF' } }
                    }
                }
            });

            volumeChart = new Chart(volumeCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Volume',
                        data: volumeData,
                        backgroundColor: 'rgba(107, 114, 128, 0.5)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    }
                }
            });
        }

        function generateChartData() {
            const symbol = state.settings.selectedAsset;
            const asset = assets[symbol];
            const basePrice = asset.price;

            const points = 50;
            const priceData = [];
            const volumeData = [];
            const labels = [];

            let price = basePrice * 0.98;
            for (let i = 0; i < points; i++) {
                price += (Math.random() - 0.48) * (basePrice * 0.01);
                priceData.push(price);
                volumeData.push(Math.floor(Math.random() * 1000000) + 100000);

                const hour = 9 + Math.floor(i * 7 / points);
                const minute = (i * 7) % 60;
                labels.push(`${hour}:${minute.toString().padStart(2, '0')}`);
            }

            return { priceData, volumeData, labels };
        }

        function updateCharts() {
            if (priceChart && volumeChart) {
                const { priceData, volumeData, labels } = generateChartData();

                priceChart.data.labels = labels;
                priceChart.data.datasets[0].data = priceData;
                priceChart.update('none');

                volumeChart.data.labels = labels;
                volumeChart.data.datasets[0].data = volumeData;
                volumeChart.update('none');
            }
        }

        // ==================== EVENT HANDLERS ====================
        function selectAsset(symbol) {
            state.settings.selectedAsset = symbol;
            saveState();
            updateMarketOverview();
            updateTradingInterface();
            updateCharts();
            updateOrderBook();
        }

        function filterAssets(filter) {
            state.settings.assetFilter = filter;
            saveState();

            document.querySelectorAll('.asset-filter').forEach(btn => {
                btn.className = 'asset-filter px-3 py-1 rounded text-sm ' +
                    (btn.textContent.toLowerCase() === filter ? 'bg-green-600' : 'bg-gray-700 hover:bg-gray-600');
            });

            updateMarketOverview();
        }

        function setOrderType(type) {
            state.settings.orderType = type;
            saveState();

            document.getElementById('marketOrderBtn').className = `flex-1 py-2 rounded text-sm ${type === 'market' ? 'bg-green-600' : 'bg-gray-700 hover:bg-gray-600'}`;
            document.getElementById('limitOrderBtn').className = `flex-1 py-2 rounded text-sm ${type === 'limit' ? 'bg-green-600' : 'bg-gray-700 hover:bg-gray-600'}`;
            document.getElementById('limitPriceContainer').classList.toggle('hidden', type === 'market');

            if (type === 'limit') {
                const asset = assets[state.settings.selectedAsset];
                document.getElementById('limitPrice').value = asset.price.toFixed(2);
            }

            updateEstimatedTotal();
        }

        function setTimeframe(tf) {
            state.settings.timeframe = tf;
            saveState();

            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.className = 'timeframe-btn px-3 py-1 rounded text-sm ' +
                    (btn.textContent === tf ? 'bg-green-600' : 'bg-gray-700 hover:bg-gray-600');
            });

            updateCharts();
        }

        function setChartTab(tab) {
            state.settings.chartTab = tab;
            saveState();

            document.getElementById('chartTabBtn').className = `px-4 py-2 rounded-t text-sm ${tab === 'chart' ? 'tab-active' : 'bg-gray-700 hover:bg-gray-600'}`;
            document.getElementById('orderbookTabBtn').className = `px-4 py-2 rounded-t text-sm ${tab === 'orderbook' ? 'tab-active' : 'bg-gray-700 hover:bg-gray-600'}`;
            document.getElementById('newsTabBtn').className = `px-4 py-2 rounded-t text-sm ${tab === 'news' ? 'tab-active' : 'bg-gray-700 hover:bg-gray-600'}`;

            document.getElementById('chartContent').classList.toggle('hidden', tab !== 'chart');
            document.getElementById('orderbookContent').classList.toggle('hidden', tab !== 'orderbook');
            document.getElementById('newsContent').classList.toggle('hidden', tab !== 'news');

            if (tab === 'orderbook') {
                updateOrderBook();
            }
        }

        function executeTrade(type) {
            const symbol = state.settings.selectedAsset;
            const asset = assets[symbol];
            const quantity = parseInt(document.getElementById('quantity').value) || 0;

            if (quantity <= 0) {
                showToast('Please enter a valid quantity', 'error');
                return;
            }

            let price = asset.price;
            if (state.settings.orderType === 'limit') {
                price = parseFloat(document.getElementById('limitPrice').value) || asset.price;
            }

            const total = quantity * price;

            if (type === 'buy') {
                if (total > state.cashBalance) {
                    showToast('Insufficient funds', 'error');
                    return;
                }

                state.cashBalance -= total;

                if (state.positions[symbol]) {
                    const existing = state.positions[symbol];
                    const totalQuantity = existing.quantity + quantity;
                    const totalCost = (existing.quantity * existing.avgPrice) + total;
                    state.positions[symbol] = {
                        quantity: totalQuantity,
                        avgPrice: totalCost / totalQuantity
                    };
                } else {
                    state.positions[symbol] = {
                        quantity: quantity,
                        avgPrice: price
                    };
                }

                showToast(`Bought ${quantity} shares of ${symbol}`, 'success');
            } else {
                if (!state.positions[symbol] || state.positions[symbol].quantity < quantity) {
                    showToast('Insufficient shares', 'error');
                    return;
                }

                state.cashBalance += total;
                state.positions[symbol].quantity -= quantity;

                if (state.positions[symbol].quantity === 0) {
                    delete state.positions[symbol];
                }

                showToast(`Sold ${quantity} shares of ${symbol}`, 'success');
            }

            // Add to trade history
            state.tradeHistory.unshift({
                type: type,
                symbol: symbol,
                quantity: quantity,
                price: price,
                total: total,
                time: new Date().toLocaleTimeString()
            });

            // Keep only last 100 trades
            if (state.tradeHistory.length > 100) {
                state.tradeHistory = state.tradeHistory.slice(0, 100);
            }

            saveState();
            updateUI();

            // Reset quantity
            document.getElementById('quantity').value = 1;
            updateEstimatedTotal();
        }

        // ==================== PRICE SIMULATION ====================
        function simulatePriceMovements() {
            Object.keys(assets).forEach(symbol => {
                const asset = assets[symbol];
                const changePercent = (Math.random() - 0.5) * 0.5; // -0.25% to +0.25%
                const priceChange = asset.price * (changePercent / 100);

                asset.price += priceChange;
                asset.change = priceChange;
            });

            updateTicker();
            updateMarketOverview();
            updateTradingInterface();
            updatePositions();
            updateHeader();

            // Update market indices
            document.getElementById('sp500').textContent = formatPercent((Math.random() - 0.3) * 2);
            document.getElementById('nasdaq').textContent = formatPercent((Math.random() - 0.3) * 2.5);
            document.getElementById('dow').textContent = formatPercent((Math.random() - 0.5) * 1.5);
        }

        // ==================== INITIALIZATION ====================
        function updateUI() {
            updateHeader();
            updateTicker();
            updateMarketOverview();
            updateTradingInterface();
            updatePositions();
            updateTradeHistory();
            updateOrderBook();
        }

        function init() {
            updateUI();
            initCharts();

            // Set up event listeners
            document.getElementById('quantity').addEventListener('input', updateEstimatedTotal);
            document.getElementById('limitPrice').addEventListener('input', updateEstimatedTotal);

            // Simulate price movements every 3 seconds
            setInterval(simulatePriceMovements, 3000);

            // Update order book every 2 seconds
            setInterval(updateOrderBook, 2000);

            console.log('Wall Street Trading Simulator initialized');
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
