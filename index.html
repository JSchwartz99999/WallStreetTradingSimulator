<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wall Street Trading Simulator | Practice Stock Trading</title>
    <meta name="description" content="A realistic stock trading simulator with live market data, portfolio management, and trading features. Practice trading stocks, commodities, and bonds risk-free.">
    <meta name="author" content="JSchwartz">
    <meta name="keywords" content="stock trading simulator, paper trading, virtual trading, stock market practice, investment simulator">

    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Wall Street Trading Simulator">
    <meta property="og:description" content="Practice stock trading with virtual money. Trade stocks, commodities, and bonds in a realistic market simulation.">
    <meta property="og:url" content="https://jschwartz99999.github.io/WallStreetTradingSimulator/">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Wall Street Trading Simulator">
    <meta name="twitter:description" content="Practice stock trading with virtual money. Trade stocks, commodities, and bonds in a realistic market simulation.">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“ˆ</text></svg>">

    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
    <!-- Note: CSP removed as Tailwind CSS CDN requires 'unsafe-eval' which is incompatible with strict CSP -->
    <!-- For production, use pre-compiled Tailwind CSS instead of CDN for full CSP support -->

    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Stylesheets -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>

    <style>
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); min-height: 100vh; }
        .card { background: rgba(31, 41, 55, 0.95); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 12px; backdrop-filter: blur(10px); }
        .ticker-scroll { animation: scroll 30s linear infinite; }
        .ticker-scroll:hover { animation-play-state: paused; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .glow-green { box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
        .glow-red { box-shadow: 0 0 20px rgba(239, 68, 68, 0.3); }
        .tab-active { background: rgba(16, 185, 129, 0.2); border-bottom: 2px solid #10B981; }
        .asset-selected { border: 2px solid #10B981 !important; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Focus styles for accessibility */
        button:focus, input:focus { outline: 2px solid #10B981; outline-offset: 2px; }
        .focus-visible:focus { outline: 2px solid #10B981; outline-offset: 2px; }

        /* Skip link for accessibility */
        .skip-link { position: absolute; top: -40px; left: 0; background: #10B981; color: white; padding: 8px; z-index: 100; }
        .skip-link:focus { top: 0; }

        /* Loading state */
        .loading { opacity: 0.5; pointer-events: none; }

        /* Mobile improvements */
        @media (max-width: 640px) {
            .header-stats { flex-direction: column; gap: 0.5rem; }
            .header-stats > div { text-align: left; display: flex; justify-content: space-between; }
        }
    </style>
</head>
<body class="text-gray-100 p-2 sm:p-4">
    <!-- Skip link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div id="app" class="max-w-7xl mx-auto" role="application" aria-label="Wall Street Trading Simulator">
        <!-- Header -->
        <header class="card p-3 sm:p-4 mb-4" role="banner">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-4">
                <div class="flex items-center gap-3 sm:gap-4 flex-wrap">
                    <h1 class="text-xl sm:text-2xl font-bold text-green-400">Wall Street Trading Simulator</h1>
                    <span class="flex items-center gap-2 text-red-400 text-sm" role="status" aria-live="polite">
                        <span class="w-2 h-2 bg-red-500 rounded-full pulse" aria-hidden="true"></span>
                        <span>LIVE MARKET</span>
                    </span>
                </div>
                <div class="flex items-center gap-4 sm:gap-6 flex-wrap header-stats w-full sm:w-auto">
                    <div class="text-left sm:text-right">
                        <div class="text-xs sm:text-sm text-gray-400">Portfolio Value</div>
                        <div id="portfolioValue" class="text-lg sm:text-xl font-bold text-green-400" aria-label="Portfolio value">$100,000.00</div>
                    </div>
                    <div class="text-left sm:text-right">
                        <div class="text-xs sm:text-sm text-gray-400">Cash Balance</div>
                        <div id="cashBalance" class="text-lg sm:text-xl font-bold text-green-400" aria-label="Cash balance">$100,000.00</div>
                    </div>
                    <div class="text-left sm:text-right">
                        <div class="text-xs sm:text-sm text-gray-400">Day's P/L</div>
                        <div id="dayPL" class="text-lg sm:text-xl font-bold text-green-400" aria-label="Day's profit and loss">$0.00</div>
                    </div>
                    <button onclick="resetPortfolio()"
                            class="px-3 sm:px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-green-500"
                            aria-label="Reset portfolio to starting balance">
                        Reset
                    </button>
                </div>
            </div>
        </header>

        <!-- Market Ticker -->
        <div class="card p-2 sm:p-3 mb-4 overflow-hidden" role="marquee" aria-label="Live market ticker">
            <div id="tickerContainer" class="flex gap-6 sm:gap-8 ticker-scroll whitespace-nowrap">
                <!-- Ticker items will be inserted here -->
            </div>
        </div>

        <!-- Main Content -->
        <main id="main-content">
            <!-- Main Grid -->
            <div class="grid grid-cols-12 gap-3 sm:gap-4 mb-4">
                <!-- Market Overview -->
                <section class="col-span-12 lg:col-span-6 card p-3 sm:p-4" aria-labelledby="market-overview-title">
                    <h2 id="market-overview-title" class="text-lg font-semibold mb-4 text-gray-200">Market Overview</h2>
                    <div class="flex flex-wrap gap-2 mb-4" role="tablist" aria-label="Filter assets by type">
                        <button onclick="filterAssets('all')" class="asset-filter px-3 py-1 rounded text-sm bg-green-600" role="tab" aria-selected="true">All</button>
                        <button onclick="filterAssets('stocks')" class="asset-filter px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600" role="tab" aria-selected="false">Stocks</button>
                        <button onclick="filterAssets('commodities')" class="asset-filter px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600" role="tab" aria-selected="false">Commodities</button>
                        <button onclick="filterAssets('bonds')" class="asset-filter px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600" role="tab" aria-selected="false">Bonds</button>
                    </div>
                    <div id="marketOverview" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-80 overflow-y-auto" role="listbox" aria-label="Available assets">
                        <!-- Asset cards will be inserted here -->
                    </div>
                </section>

                <!-- Trading Interface -->
                <section class="col-span-12 lg:col-span-3 card p-3 sm:p-4" aria-labelledby="trading-title">
                    <h2 id="trading-title" class="text-lg font-semibold mb-4 text-gray-200">Trade</h2>
                    <div id="selectedAssetInfo" class="mb-4 p-3 bg-gray-700 rounded-lg">
                        <div class="text-sm text-gray-400">Selected Asset</div>
                        <div id="selectedSymbol" class="text-xl font-bold text-green-400">AAPL</div>
                        <div id="selectedPrice" class="text-lg">$262.24</div>
                    </div>

                    <form id="tradeForm" onsubmit="return false;" class="mb-4">
                        <fieldset>
                            <legend class="sr-only">Order Type</legend>
                            <div class="flex gap-2 mb-3" role="group" aria-label="Order type selection">
                                <button type="button" onclick="setOrderType('market')" id="marketOrderBtn" class="flex-1 py-2 rounded text-sm bg-green-600" aria-pressed="true">Market</button>
                                <button type="button" onclick="setOrderType('limit')" id="limitOrderBtn" class="flex-1 py-2 rounded text-sm bg-gray-700 hover:bg-gray-600" aria-pressed="false">Limit</button>
                            </div>
                        </fieldset>

                        <div class="space-y-3">
                            <div>
                                <label for="quantity" class="block text-sm text-gray-400 mb-1">Quantity</label>
                                <input type="number"
                                       id="quantity"
                                       name="quantity"
                                       min="1"
                                       max="100000"
                                       value="1"
                                       required
                                       class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-green-500 focus:outline-none"
                                       aria-describedby="maxSharesHint">
                            </div>
                            <div id="limitPriceContainer" class="hidden">
                                <label for="limitPrice" class="block text-sm text-gray-400 mb-1">Limit Price</label>
                                <input type="number"
                                       id="limitPrice"
                                       name="limitPrice"
                                       step="0.01"
                                       min="0.01"
                                       class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-green-500 focus:outline-none">
                            </div>
                            <div class="text-sm text-gray-400">
                                Estimated Total: <span id="estimatedTotal" class="text-white font-semibold">$262.24</span>
                            </div>
                            <div id="maxSharesHint" class="text-sm text-gray-400">
                                Max Shares: <span id="maxShares" class="text-white">381</span>
                            </div>
                        </div>
                    </form>

                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="executeTrade('buy')"
                                class="py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition-colors glow-green focus:ring-2 focus:ring-green-400"
                                aria-label="Buy selected asset">
                            BUY
                        </button>
                        <button onclick="executeTrade('sell')"
                                class="py-3 bg-red-600 hover:bg-red-700 rounded-lg font-semibold transition-colors glow-red focus:ring-2 focus:ring-red-400"
                                aria-label="Sell selected asset">
                            SELL
                        </button>
                    </div>
                </section>

                <!-- Market Status -->
                <section class="col-span-12 lg:col-span-3 card p-3 sm:p-4" aria-labelledby="market-status-title">
                    <h2 id="market-status-title" class="text-lg font-semibold mb-4 text-gray-200">Market Status</h2>
                    <dl class="space-y-3 sm:space-y-4">
                        <div class="flex justify-between items-center">
                            <dt class="text-gray-400">Market Hours</dt>
                            <dd id="marketHours" class="text-green-400 font-semibold">Open</dd>
                        </div>
                        <div class="flex justify-between items-center">
                            <dt class="text-gray-400">S&P 500</dt>
                            <dd id="sp500" class="text-green-400">+1.24%</dd>
                        </div>
                        <div class="flex justify-between items-center">
                            <dt class="text-gray-400">NASDAQ</dt>
                            <dd id="nasdaq" class="text-green-400">+1.56%</dd>
                        </div>
                        <div class="flex justify-between items-center">
                            <dt class="text-gray-400">DOW</dt>
                            <dd id="dow" class="text-red-400">-0.32%</dd>
                        </div>
                        <div class="flex justify-between items-center">
                            <dt class="text-gray-400">VIX</dt>
                            <dd id="vix" class="text-yellow-400">16.42</dd>
                        </div>
                        <div class="flex justify-between items-center">
                            <dt class="text-gray-400">Volume</dt>
                            <dd id="volume" class="text-gray-200">2.4B</dd>
                        </div>
                    </dl>
                </section>
            </div>

            <!-- Charts and Analysis Section -->
            <div class="grid grid-cols-12 gap-3 sm:gap-4 mb-4">
                <!-- Price Chart -->
                <section class="col-span-12 lg:col-span-6 card p-3 sm:p-4" aria-labelledby="charts-title">
                    <h2 id="charts-title" class="sr-only">Charts and Analysis</h2>
                    <div class="flex flex-wrap gap-2 mb-4" role="tablist" aria-label="Chart view options">
                        <button onclick="setChartTab('chart')" id="chartTabBtn" class="tab-active px-3 sm:px-4 py-2 rounded-t text-sm" role="tab" aria-selected="true" aria-controls="chartContent">Price Chart</button>
                        <button onclick="setChartTab('orderbook')" id="orderbookTabBtn" class="px-3 sm:px-4 py-2 rounded-t text-sm bg-gray-700 hover:bg-gray-600" role="tab" aria-selected="false" aria-controls="orderbookContent">Order Book</button>
                        <button onclick="setChartTab('news')" id="newsTabBtn" class="px-3 sm:px-4 py-2 rounded-t text-sm bg-gray-700 hover:bg-gray-600" role="tab" aria-selected="false" aria-controls="newsContent">Market News</button>
                    </div>

                    <div id="chartContent" role="tabpanel" aria-labelledby="chartTabBtn">
                        <div class="flex flex-wrap gap-2 mb-4" role="group" aria-label="Chart timeframe">
                            <button onclick="setTimeframe('1D')" class="timeframe-btn px-3 py-1 rounded text-sm bg-green-600">1D</button>
                            <button onclick="setTimeframe('5D')" class="timeframe-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600">5D</button>
                            <button onclick="setTimeframe('1M')" class="timeframe-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600">1M</button>
                            <button onclick="setTimeframe('3M')" class="timeframe-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600">3M</button>
                            <button onclick="setTimeframe('1Y')" class="timeframe-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600">1Y</button>
                        </div>
                        <div id="chartContainer">
                            <canvas id="priceChart" height="250" aria-label="Price chart for selected asset"></canvas>
                            <canvas id="volumeChart" height="80" class="mt-2" aria-label="Volume chart for selected asset"></canvas>
                        </div>
                        <div id="chartFallback" class="hidden p-8 text-center text-gray-400">
                            <p>Chart could not be loaded. Please refresh the page.</p>
                        </div>
                    </div>

                    <div id="orderbookContent" class="hidden" role="tabpanel" aria-labelledby="orderbookTabBtn">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h3 class="text-red-400 font-semibold mb-2">Bids (Buy Orders)</h3>
                                <div id="bids" class="space-y-1 text-sm" role="list" aria-label="Buy orders">
                                    <!-- Bids will be inserted here -->
                                </div>
                            </div>
                            <div>
                                <h3 class="text-green-400 font-semibold mb-2">Asks (Sell Orders)</h3>
                                <div id="asks" class="space-y-1 text-sm" role="list" aria-label="Sell orders">
                                    <!-- Asks will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="newsContent" class="hidden space-y-3" role="tabpanel" aria-labelledby="newsTabBtn">
                        <article class="p-3 bg-gray-700 rounded-lg">
                            <h3 class="text-green-400 font-semibold">Tech Stocks Rally on AI Optimism</h3>
                            <p class="text-sm text-gray-400 mt-1">Major technology companies see gains as investors remain bullish on artificial intelligence developments.</p>
                            <time class="text-xs text-gray-500 mt-2 block">2 hours ago</time>
                        </article>
                        <article class="p-3 bg-gray-700 rounded-lg">
                            <h3 class="text-red-400 font-semibold">Fed Signals Potential Rate Changes</h3>
                            <p class="text-sm text-gray-400 mt-1">Federal Reserve officials hint at possible adjustments to monetary policy in upcoming meetings.</p>
                            <time class="text-xs text-gray-500 mt-2 block">4 hours ago</time>
                        </article>
                        <article class="p-3 bg-gray-700 rounded-lg">
                            <h3 class="text-green-400 font-semibold">Energy Sector Shows Strong Performance</h3>
                            <p class="text-sm text-gray-400 mt-1">Oil prices stabilize as global demand outlook improves, boosting energy stocks.</p>
                            <time class="text-xs text-gray-500 mt-2 block">6 hours ago</time>
                        </article>
                    </div>
                </section>

                <!-- Portfolio -->
                <section class="col-span-12 lg:col-span-3 card p-3 sm:p-4" aria-labelledby="portfolio-title">
                    <h2 id="portfolio-title" class="text-lg font-semibold mb-4 text-gray-200">Portfolio</h2>
                    <div class="mb-4 p-3 bg-gray-700 rounded-lg">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Total Value</span>
                            <span id="totalValue" class="text-green-400 font-bold">$100,000.00</span>
                        </div>
                        <div class="flex justify-between mt-2">
                            <span class="text-gray-400">Total P/L</span>
                            <span id="totalPL" class="text-green-400">$0.00 (0.00%)</span>
                        </div>
                    </div>
                    <div id="positions" class="space-y-2 max-h-60 overflow-y-auto" role="list" aria-label="Current positions">
                        <div class="text-center text-gray-500 py-4">No positions yet</div>
                    </div>
                </section>

                <!-- Trade History -->
                <section class="col-span-12 lg:col-span-3 card p-3 sm:p-4" aria-labelledby="history-title">
                    <h2 id="history-title" class="text-lg font-semibold mb-4 text-gray-200">Trade History</h2>
                    <div id="tradeHistory" class="space-y-2 max-h-80 overflow-y-auto" role="list" aria-label="Trade history">
                        <div class="text-center text-gray-500 py-4">No trades yet</div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Footer -->
        <footer class="card p-3 sm:p-4 text-center text-gray-400 text-sm" role="contentinfo">
            <p>Wall Street Trading Simulator - For Educational Purposes Only</p>
            <p class="mt-1">Data is simulated and does not represent real market conditions</p>
            <p class="mt-2 text-xs">
                <a href="https://github.com/JSchwartz99999/WallStreetTradingSimulator" class="text-green-400 hover:text-green-300" target="_blank" rel="noopener noreferrer">View on GitHub</a>
            </p>
        </footer>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50" role="alert" aria-live="polite">
        <span id="toastMessage"></span>
    </div>

    <!-- Screen reader announcements -->
    <div id="srAnnounce" class="sr-only" aria-live="polite" aria-atomic="true"></div>

    <script>
        'use strict';

        // ==================== SECURITY UTILITIES ====================
        const SecurityUtils = Object.freeze({
            // Rate limiter for preventing rapid submissions
            rateLimiter: (() => {
                const attempts = new Map();
                const MAX_ATTEMPTS = 10;
                const WINDOW_MS = 60000; // 1 minute

                return {
                    check(action) {
                        const now = Date.now();
                        const key = action;
                        const record = attempts.get(key) ?? { count: 0, resetTime: now + WINDOW_MS };

                        if (now > record.resetTime) {
                            record.count = 0;
                            record.resetTime = now + WINDOW_MS;
                        }

                        if (record.count >= MAX_ATTEMPTS) {
                            return false;
                        }

                        record.count++;
                        attempts.set(key, record);
                        return true;
                    },
                    reset(action) {
                        attempts.delete(action);
                    }
                };
            })(),

            // Enhanced HTML sanitization
            sanitizeHTML(str) {
                if (typeof str !== 'string') return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },

            // Validate and sanitize number input
            sanitizeNumber(value, min = 0, max = Number.MAX_SAFE_INTEGER, decimals = 2) {
                const num = parseFloat(value);
                if (!Number.isFinite(num)) return min;
                const clamped = Math.max(min, Math.min(max, num));
                return Number(clamped.toFixed(decimals));
            },

            // Validate symbol format
            isValidSymbol(symbol, allowedSymbols) {
                return typeof symbol === 'string' &&
                       symbol.length <= 10 &&
                       /^[A-Z0-9]+$/.test(symbol) &&
                       allowedSymbols.has(symbol);
            },

            // Deep freeze object to prevent mutation
            deepFreeze(obj) {
                Object.keys(obj).forEach(prop => {
                    if (typeof obj[prop] === 'object' && obj[prop] !== null) {
                        SecurityUtils.deepFreeze(obj[prop]);
                    }
                });
                return Object.freeze(obj);
            }
        });

        // ==================== STATE MANAGEMENT ====================
        const STORAGE_KEY = 'wallStreetSimulator';
        const STORAGE_VERSION = '1.1';

        const defaultState = {
            version: STORAGE_VERSION,
            cashBalance: 100000,
            positions: {},
            tradeHistory: [],
            settings: {
                orderType: 'market',
                selectedAsset: 'AAPL',
                timeframe: '1D',
                chartTab: 'chart',
                assetFilter: 'all'
            }
        };

        let state = loadState();
        let priceChart = null;
        let volumeChart = null;
        let updateIntervals = [];

        // Asset data with validation (Prices updated: January 6, 2026)
        const assets = Object.freeze({
            // Stocks
            AAPL: { name: 'Apple Inc.', type: 'stocks', price: 262.24, change: -5.02 },
            MSFT: { name: 'Microsoft', type: 'stocks', price: 475.00, change: 2.15 },
            TSLA: { name: 'Tesla Inc.', type: 'stocks', price: 432.96, change: -18.71 },
            GOOGL: { name: 'Alphabet', type: 'stocks', price: 314.34, change: -2.36 },
            AMZN: { name: 'Amazon', type: 'stocks', price: 240.92, change: 7.86 },
            META: { name: 'Meta Platforms', type: 'stocks', price: 660.46, change: 1.67 },
            NVDA: { name: 'NVIDIA', type: 'stocks', price: 187.27, change: -0.85 },
            JPM: { name: 'JPMorgan Chase', type: 'stocks', price: 334.29, change: 1.75 },
            // Commodities
            GC: { name: 'Gold', type: 'commodities', price: 4478.24, change: 30.24 },
            CL: { name: 'Crude Oil', type: 'commodities', price: 58.15, change: -0.17 },
            SI: { name: 'Silver', type: 'commodities', price: 81.52, change: 4.97 },
            // Bonds
            TNX: { name: '10Y Treasury', type: 'bonds', price: 4.19, change: 0.02 },
            TYX: { name: '30Y Treasury', type: 'bonds', price: 4.88, change: 0.03 }
        });

        // Mutable copy for price updates
        const liveAssets = JSON.parse(JSON.stringify(assets));

        // Ticker symbols
        const tickerSymbols = ['SPY', 'QQQ', 'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'META', 'NVDA', 'JPM'];

        // ==================== UTILITY FUNCTIONS ====================
        // Create a Set of valid symbols for O(1) lookup
        const validSymbolSet = new Set(Object.keys(assets));

        function sanitizeHTML(str) {
            return SecurityUtils.sanitizeHTML(str);
        }

        function isValidSymbol(symbol) {
            return SecurityUtils.isValidSymbol(symbol, validSymbolSet) && symbol in liveAssets;
        }

        function isValidNumber(value, min = 0, max = Infinity) {
            const num = parseFloat(value);
            return Number.isFinite(num) && num >= min && num <= max;
        }

        function announceToScreenReader(message) {
            const announcer = document.getElementById('srAnnounce');
            if (announcer) {
                announcer.textContent = message;
                setTimeout(() => { announcer.textContent = ''; }, 1000);
            }
        }

        // ==================== LOCAL STORAGE ====================
        function loadState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Validate and merge with defaults
                    if (parsed && typeof parsed === 'object') {
                        // Version check for future migrations
                        if (parsed.version !== STORAGE_VERSION) {
                            console.log('State version mismatch, using defaults');
                            return { ...defaultState };
                        }
                        return {
                            ...defaultState,
                            ...parsed,
                            settings: { ...defaultState.settings, ...(parsed.settings || {}) }
                        };
                    }
                }
            } catch (e) {
                console.error('Error loading state:', e);
            }
            return { ...defaultState };
        }

        function saveState() {
            try {
                state.version = STORAGE_VERSION;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (e) {
                console.error('Error saving state:', e);
                showToast('Failed to save data', 'error');
            }
        }

        function resetPortfolio() {
            if (confirm('Are you sure you want to reset your portfolio? This will clear all positions and trade history.')) {
                state = { ...defaultState };
                saveState();
                updateUI();
                showToast('Portfolio reset successfully', 'success');
                announceToScreenReader('Portfolio has been reset to starting balance of $100,000');
            }
        }

        // ==================== FORMATTING ====================
        function formatCurrency(amount) {
            if (!isValidNumber(amount, -Infinity, Infinity)) return '$0.00';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function formatPercent(value) {
            if (!isValidNumber(value, -Infinity, Infinity)) return '+0.00%';
            const sign = value >= 0 ? '+' : '';
            return `${sign}${value.toFixed(2)}%`;
        }

        // ==================== TOAST NOTIFICATIONS ====================
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            if (!toast || !toastMessage) return;

            const bgColor = type === 'success' ? 'bg-green-600' :
                           type === 'error' ? 'bg-red-600' : 'bg-blue-600';

            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 z-50 ${bgColor}`;
            toastMessage.textContent = sanitizeHTML(message);

            toast.classList.remove('translate-y-20', 'opacity-0');

            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // ==================== UI UPDATES ====================
        function updateHeader() {
            try {
                const portfolioValue = calculatePortfolioValue();
                const cashBalance = state.cashBalance;
                const totalValue = portfolioValue + cashBalance;
                const initialValue = 100000;
                const dayPL = totalValue - initialValue;

                const portfolioEl = document.getElementById('portfolioValue');
                const cashEl = document.getElementById('cashBalance');
                const plEl = document.getElementById('dayPL');

                if (portfolioEl) {
                    portfolioEl.textContent = formatCurrency(totalValue);
                    portfolioEl.className = `text-lg sm:text-xl font-bold ${totalValue >= initialValue ? 'text-green-400' : 'text-red-400'}`;
                }

                if (cashEl) {
                    cashEl.textContent = formatCurrency(cashBalance);
                }

                if (plEl) {
                    plEl.textContent = formatCurrency(dayPL);
                    plEl.className = `text-lg sm:text-xl font-bold ${dayPL >= 0 ? 'text-green-400' : 'text-red-400'}`;
                }
            } catch (e) {
                console.error('Error updating header:', e);
            }
        }

        function updateTicker() {
            const container = document.getElementById('tickerContainer');
            if (!container) return;

            let html = '';
            tickerSymbols.forEach(symbol => {
                const asset = liveAssets[symbol] || { price: 100, change: 0 };
                const isPositive = asset.change >= 0;
                const changePercent = asset.price > 0 ? ((asset.change / asset.price) * 100).toFixed(2) : '0.00';

                html += `
                    <div class="flex items-center gap-3" role="listitem">
                        <span class="font-semibold text-white">${sanitizeHTML(symbol)}</span>
                        <span class="text-gray-300">${formatCurrency(asset.price)}</span>
                        <span class="${isPositive ? 'text-green-400' : 'text-red-400'} flex items-center gap-1">
                            <span aria-hidden="true">${isPositive ? 'â–²' : 'â–¼'}</span>
                            <span>${formatPercent(parseFloat(changePercent))}</span>
                        </span>
                    </div>
                `;
            });

            container.innerHTML = html + html; // Duplicate for seamless scroll
        }

        function updateMarketOverview() {
            const container = document.getElementById('marketOverview');
            if (!container) return;

            const filter = state.settings.assetFilter;
            let html = '';

            Object.entries(liveAssets).forEach(([symbol, asset]) => {
                if (filter !== 'all' && asset.type !== filter) return;

                const isPositive = asset.change >= 0;
                const changePercent = asset.price > 0 ? ((asset.change / asset.price) * 100).toFixed(2) : '0.00';
                const isSelected = state.settings.selectedAsset === symbol;

                const typeColors = {
                    stocks: { bg: 'bg-blue-900', text: 'text-blue-300' },
                    commodities: { bg: 'bg-yellow-900', text: 'text-yellow-300' },
                    bonds: { bg: 'bg-purple-900', text: 'text-purple-300' }
                };
                const colors = typeColors[asset.type] || typeColors.stocks;

                html += `
                    <div onclick="selectAsset('${sanitizeHTML(symbol)}')"
                         onkeydown="if(event.key==='Enter'||event.key===' ')selectAsset('${sanitizeHTML(symbol)}')"
                         tabindex="0"
                         role="option"
                         aria-selected="${isSelected}"
                         class="p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors ${isSelected ? 'asset-selected' : ''} border border-transparent focus:outline-none focus:ring-2 focus:ring-green-500">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-semibold text-white">${sanitizeHTML(symbol)}</span>
                            <span class="text-xs px-2 py-0.5 rounded ${colors.bg} ${colors.text}">${sanitizeHTML(asset.type)}</span>
                        </div>
                        <div class="text-lg font-bold text-white">${formatCurrency(asset.price)}</div>
                        <div class="${isPositive ? 'text-green-400' : 'text-red-400'} text-sm flex items-center gap-1">
                            <span aria-hidden="true">${isPositive ? 'â–²' : 'â–¼'}</span>
                            ${formatCurrency(Math.abs(asset.change))} (${formatPercent(parseFloat(changePercent))})
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateTradingInterface() {
            const symbol = state.settings.selectedAsset;
            if (!isValidSymbol(symbol)) return;

            const asset = liveAssets[symbol];
            const symbolEl = document.getElementById('selectedSymbol');
            const priceEl = document.getElementById('selectedPrice');

            if (symbolEl) symbolEl.textContent = symbol;
            if (priceEl) priceEl.textContent = formatCurrency(asset.price);

            updateEstimatedTotal();
            updateMaxShares();
        }

        function updateEstimatedTotal() {
            const symbol = state.settings.selectedAsset;
            if (!isValidSymbol(symbol)) return;

            const asset = liveAssets[symbol];
            const quantityEl = document.getElementById('quantity');
            const quantity = parseInt(quantityEl?.value) || 0;
            const orderType = state.settings.orderType;

            let price = asset.price;
            if (orderType === 'limit') {
                const limitPriceEl = document.getElementById('limitPrice');
                price = parseFloat(limitPriceEl?.value) || asset.price;
            }

            const totalEl = document.getElementById('estimatedTotal');
            if (totalEl) {
                totalEl.textContent = formatCurrency(quantity * price);
            }
        }

        function updateMaxShares() {
            const symbol = state.settings.selectedAsset;
            if (!isValidSymbol(symbol)) return;

            const asset = liveAssets[symbol];
            const maxShares = asset.price > 0 ? Math.floor(state.cashBalance / asset.price) : 0;
            const maxSharesEl = document.getElementById('maxShares');
            if (maxSharesEl) {
                maxSharesEl.textContent = maxShares.toLocaleString();
            }
        }

        function updatePositions() {
            const container = document.getElementById('positions');
            if (!container) return;

            const positions = state.positions;

            if (Object.keys(positions).length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">No positions yet</div>';
                return;
            }

            let html = '';
            Object.entries(positions).forEach(([symbol, position]) => {
                if (!isValidSymbol(symbol)) return;

                const asset = liveAssets[symbol];
                const currentValue = position.quantity * asset.price;
                const costBasis = position.quantity * position.avgPrice;
                const pl = currentValue - costBasis;
                const plPercent = costBasis > 0 ? ((pl / costBasis) * 100).toFixed(2) : '0.00';
                const isPositive = pl >= 0;

                html += `
                    <div class="p-3 bg-gray-700 rounded-lg" role="listitem">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="font-semibold text-white">${sanitizeHTML(symbol)}</span>
                                <span class="text-gray-400 text-sm ml-2">${position.quantity} shares</span>
                            </div>
                            <span class="text-white font-bold">${formatCurrency(currentValue)}</span>
                        </div>
                        <div class="flex justify-between items-center mt-1 text-sm">
                            <span class="text-gray-400">Avg: ${formatCurrency(position.avgPrice)}</span>
                            <span class="${isPositive ? 'text-green-400' : 'text-red-400'} flex items-center gap-1">
                                <span aria-hidden="true">${isPositive ? 'â–²' : 'â–¼'}</span>
                                ${formatCurrency(Math.abs(pl))} (${formatPercent(parseFloat(plPercent))})
                            </span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Update portfolio totals
            const totalValue = calculatePortfolioValue() + state.cashBalance;
            const totalPL = totalValue - 100000;
            const totalPLPercent = ((totalPL / 100000) * 100).toFixed(2);

            const totalValueEl = document.getElementById('totalValue');
            const totalPLEl = document.getElementById('totalPL');

            if (totalValueEl) totalValueEl.textContent = formatCurrency(totalValue);
            if (totalPLEl) {
                totalPLEl.textContent = `${formatCurrency(totalPL)} (${formatPercent(parseFloat(totalPLPercent))})`;
                totalPLEl.className = totalPL >= 0 ? 'text-green-400' : 'text-red-400';
            }
        }

        function updateTradeHistory() {
            const container = document.getElementById('tradeHistory');
            if (!container) return;

            const history = state.tradeHistory;

            if (!history || history.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">No trades yet</div>';
                return;
            }

            let html = '';
            history.slice(0, 20).forEach(trade => {
                const isBuy = trade.type === 'buy';

                html += `
                    <div class="p-2 bg-gray-700 rounded text-sm" role="listitem">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold ${isBuy ? 'text-green-400' : 'text-red-400'}">${sanitizeHTML(trade.type.toUpperCase())}</span>
                            <span class="text-gray-400 text-xs">${sanitizeHTML(trade.time)}</span>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-white">${sanitizeHTML(trade.symbol)} x${trade.quantity}</span>
                            <span class="text-gray-300">@ ${formatCurrency(trade.price)}</span>
                        </div>
                        <div class="text-right text-gray-400 text-xs mt-1">
                            Total: ${formatCurrency(trade.total)}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateOrderBook() {
            const symbol = state.settings.selectedAsset;
            if (!isValidSymbol(symbol)) return;

            const asset = liveAssets[symbol];
            const basePrice = asset.price;

            const bidsEl = document.getElementById('bids');
            const asksEl = document.getElementById('asks');
            if (!bidsEl || !asksEl) return;

            let bidsHtml = '';
            let asksHtml = '';

            for (let i = 0; i < 8; i++) {
                const bidPrice = basePrice - (i + 1) * 0.05;
                const bidSize = Math.floor(Math.random() * 500) + 100;
                bidsHtml += `
                    <div class="flex justify-between text-red-400" role="listitem">
                        <span>${formatCurrency(bidPrice)}</span>
                        <span>${bidSize}</span>
                    </div>
                `;

                const askPrice = basePrice + (i + 1) * 0.05;
                const askSize = Math.floor(Math.random() * 500) + 100;
                asksHtml += `
                    <div class="flex justify-between text-green-400" role="listitem">
                        <span>${formatCurrency(askPrice)}</span>
                        <span>${askSize}</span>
                    </div>
                `;
            }

            bidsEl.innerHTML = bidsHtml;
            asksEl.innerHTML = asksHtml;
        }

        function calculatePortfolioValue() {
            let total = 0;
            Object.entries(state.positions).forEach(([symbol, position]) => {
                if (isValidSymbol(symbol) && position && position.quantity > 0) {
                    const asset = liveAssets[symbol];
                    total += position.quantity * asset.price;
                }
            });
            return total;
        }

        // ==================== CHART FUNCTIONS ====================
        function initCharts() {
            try {
                if (typeof Chart === 'undefined') {
                    throw new Error('Chart.js not loaded');
                }

                const priceCanvas = document.getElementById('priceChart');
                const volumeCanvas = document.getElementById('volumeChart');

                if (!priceCanvas || !volumeCanvas) {
                    throw new Error('Chart canvas elements not found');
                }

                const priceCtx = priceCanvas.getContext('2d');
                const volumeCtx = volumeCanvas.getContext('2d');

                const { priceData, volumeData, labels } = generateChartData();

                priceChart = new Chart(priceCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Price',
                            data: priceData,
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { color: 'rgba(75, 85, 99, 0.3)' }, ticks: { color: '#9CA3AF' } },
                            y: { grid: { color: 'rgba(75, 85, 99, 0.3)' }, ticks: { color: '#9CA3AF' } }
                        }
                    }
                });

                volumeChart = new Chart(volumeCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Volume',
                            data: volumeData,
                            backgroundColor: 'rgba(107, 114, 128, 0.5)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { display: false },
                            y: { display: false }
                        }
                    }
                });

                document.getElementById('chartContainer')?.classList.remove('hidden');
                document.getElementById('chartFallback')?.classList.add('hidden');
            } catch (e) {
                console.error('Error initializing charts:', e);
                document.getElementById('chartContainer')?.classList.add('hidden');
                document.getElementById('chartFallback')?.classList.remove('hidden');
            }
        }

        function generateChartData() {
            const symbol = state.settings.selectedAsset;
            const asset = liveAssets[symbol] || { price: 100 };
            const basePrice = asset.price;

            const points = 50;
            const priceData = [];
            const volumeData = [];
            const labels = [];

            let price = basePrice * 0.98;
            for (let i = 0; i < points; i++) {
                price += (Math.random() - 0.48) * (basePrice * 0.01);
                priceData.push(price);
                volumeData.push(Math.floor(Math.random() * 1000000) + 100000);

                const hour = 9 + Math.floor(i * 7 / points);
                const minute = (i * 7) % 60;
                labels.push(`${hour}:${minute.toString().padStart(2, '0')}`);
            }

            return { priceData, volumeData, labels };
        }

        function updateCharts() {
            if (priceChart && volumeChart) {
                try {
                    const { priceData, volumeData, labels } = generateChartData();

                    priceChart.data.labels = labels;
                    priceChart.data.datasets[0].data = priceData;
                    priceChart.update('none');

                    volumeChart.data.labels = labels;
                    volumeChart.data.datasets[0].data = volumeData;
                    volumeChart.update('none');
                } catch (e) {
                    console.error('Error updating charts:', e);
                }
            }
        }

        // ==================== EVENT HANDLERS ====================
        function selectAsset(symbol) {
            if (!isValidSymbol(symbol)) {
                showToast('Invalid asset selected', 'error');
                return;
            }

            state.settings.selectedAsset = symbol;
            saveState();
            updateMarketOverview();
            updateTradingInterface();
            updateCharts();
            updateOrderBook();
            announceToScreenReader(`Selected ${symbol} at ${formatCurrency(liveAssets[symbol].price)}`);
        }

        function filterAssets(filter) {
            const validFilters = ['all', 'stocks', 'commodities', 'bonds'];
            if (!validFilters.includes(filter)) return;

            state.settings.assetFilter = filter;
            saveState();

            document.querySelectorAll('.asset-filter').forEach(btn => {
                const isActive = btn.textContent.toLowerCase() === filter;
                btn.className = 'asset-filter px-3 py-1 rounded text-sm ' +
                    (isActive ? 'bg-green-600' : 'bg-gray-700 hover:bg-gray-600');
                btn.setAttribute('aria-selected', isActive);
            });

            updateMarketOverview();
            announceToScreenReader(`Filtering by ${filter}`);
        }

        function setOrderType(type) {
            if (type !== 'market' && type !== 'limit') return;

            state.settings.orderType = type;
            saveState();

            const marketBtn = document.getElementById('marketOrderBtn');
            const limitBtn = document.getElementById('limitOrderBtn');
            const limitContainer = document.getElementById('limitPriceContainer');

            if (marketBtn) {
                marketBtn.className = `flex-1 py-2 rounded text-sm ${type === 'market' ? 'bg-green-600' : 'bg-gray-700 hover:bg-gray-600'}`;
                marketBtn.setAttribute('aria-pressed', type === 'market');
            }
            if (limitBtn) {
                limitBtn.className = `flex-1 py-2 rounded text-sm ${type === 'limit' ? 'bg-green-600' : 'bg-gray-700 hover:bg-gray-600'}`;
                limitBtn.setAttribute('aria-pressed', type === 'limit');
            }
            if (limitContainer) {
                limitContainer.classList.toggle('hidden', type === 'market');
            }

            if (type === 'limit') {
                const asset = liveAssets[state.settings.selectedAsset];
                const limitPriceEl = document.getElementById('limitPrice');
                if (limitPriceEl && asset) {
                    limitPriceEl.value = asset.price.toFixed(2);
                }
            }

            updateEstimatedTotal();
        }

        function setTimeframe(tf) {
            const validTimeframes = ['1D', '5D', '1M', '3M', '1Y'];
            if (!validTimeframes.includes(tf)) return;

            state.settings.timeframe = tf;
            saveState();

            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.className = 'timeframe-btn px-3 py-1 rounded text-sm ' +
                    (btn.textContent === tf ? 'bg-green-600' : 'bg-gray-700 hover:bg-gray-600');
            });

            updateCharts();
        }

        function setChartTab(tab) {
            const validTabs = ['chart', 'orderbook', 'news'];
            if (!validTabs.includes(tab)) return;

            state.settings.chartTab = tab;
            saveState();

            const chartBtn = document.getElementById('chartTabBtn');
            const orderbookBtn = document.getElementById('orderbookTabBtn');
            const newsBtn = document.getElementById('newsTabBtn');

            [chartBtn, orderbookBtn, newsBtn].forEach(btn => {
                if (btn) {
                    const isActive = btn.id.includes(tab);
                    btn.className = `px-3 sm:px-4 py-2 rounded-t text-sm ${isActive ? 'tab-active' : 'bg-gray-700 hover:bg-gray-600'}`;
                    btn.setAttribute('aria-selected', isActive);
                }
            });

            document.getElementById('chartContent')?.classList.toggle('hidden', tab !== 'chart');
            document.getElementById('orderbookContent')?.classList.toggle('hidden', tab !== 'orderbook');
            document.getElementById('newsContent')?.classList.toggle('hidden', tab !== 'news');

            if (tab === 'orderbook') {
                updateOrderBook();
            }
        }

        function executeTrade(type) {
            if (type !== 'buy' && type !== 'sell') return;

            // Rate limiting check
            if (!SecurityUtils.rateLimiter.check('trade')) {
                showToast('Too many trades. Please wait a moment.', 'error');
                return;
            }

            const symbol = state.settings.selectedAsset;
            if (!isValidSymbol(symbol)) {
                showToast('Invalid asset selected', 'error');
                return;
            }

            const asset = liveAssets[symbol];
            const quantityEl = document.getElementById('quantity');
            const quantity = parseInt(quantityEl?.value);

            // Validate quantity
            if (!isValidNumber(quantity, 1, 100000)) {
                showToast('Please enter a valid quantity (1-100,000)', 'error');
                return;
            }

            let price = asset.price;
            if (state.settings.orderType === 'limit') {
                const limitPriceEl = document.getElementById('limitPrice');
                const limitPrice = parseFloat(limitPriceEl?.value);
                if (!isValidNumber(limitPrice, 0.01)) {
                    showToast('Please enter a valid limit price', 'error');
                    return;
                }
                price = limitPrice;
            }

            const total = quantity * price;

            if (type === 'buy') {
                if (total > state.cashBalance) {
                    showToast('Insufficient funds', 'error');
                    return;
                }

                state.cashBalance -= total;

                if (state.positions[symbol]) {
                    const existing = state.positions[symbol];
                    const totalQuantity = existing.quantity + quantity;
                    const totalCost = (existing.quantity * existing.avgPrice) + total;
                    state.positions[symbol] = {
                        quantity: totalQuantity,
                        avgPrice: totalCost / totalQuantity
                    };
                } else {
                    state.positions[symbol] = {
                        quantity: quantity,
                        avgPrice: price
                    };
                }

                showToast(`Bought ${quantity} shares of ${symbol}`, 'success');
                announceToScreenReader(`Successfully bought ${quantity} shares of ${symbol} at ${formatCurrency(price)} each`);
            } else {
                if (!state.positions[symbol] || state.positions[symbol].quantity < quantity) {
                    showToast('Insufficient shares to sell', 'error');
                    return;
                }

                state.cashBalance += total;
                state.positions[symbol].quantity -= quantity;

                if (state.positions[symbol].quantity === 0) {
                    delete state.positions[symbol];
                }

                showToast(`Sold ${quantity} shares of ${symbol}`, 'success');
                announceToScreenReader(`Successfully sold ${quantity} shares of ${symbol} at ${formatCurrency(price)} each`);
            }

            // Add to trade history
            state.tradeHistory.unshift({
                type: type,
                symbol: symbol,
                quantity: quantity,
                price: price,
                total: total,
                time: new Date().toLocaleTimeString()
            });

            // Keep only last 100 trades
            if (state.tradeHistory.length > 100) {
                state.tradeHistory = state.tradeHistory.slice(0, 100);
            }

            saveState();
            updateUI();

            // Reset quantity
            if (quantityEl) quantityEl.value = 1;
            updateEstimatedTotal();
        }

        // ==================== PRICE SIMULATION ====================
        function simulatePriceMovements() {
            Object.keys(liveAssets).forEach(symbol => {
                const asset = liveAssets[symbol];
                const changePercent = (Math.random() - 0.5) * 0.5; // -0.25% to +0.25%
                const priceChange = asset.price * (changePercent / 100);

                asset.price = Math.max(0.01, asset.price + priceChange); // Ensure price stays positive
                asset.change = priceChange;
            });

            updateTicker();
            updateMarketOverview();
            updateTradingInterface();
            updatePositions();
            updateHeader();

            // Update market indices
            const sp500El = document.getElementById('sp500');
            const nasdaqEl = document.getElementById('nasdaq');
            const dowEl = document.getElementById('dow');

            if (sp500El) {
                const sp500Val = (Math.random() - 0.3) * 2;
                sp500El.textContent = formatPercent(sp500Val);
                sp500El.className = sp500Val >= 0 ? 'text-green-400' : 'text-red-400';
            }
            if (nasdaqEl) {
                const nasdaqVal = (Math.random() - 0.3) * 2.5;
                nasdaqEl.textContent = formatPercent(nasdaqVal);
                nasdaqEl.className = nasdaqVal >= 0 ? 'text-green-400' : 'text-red-400';
            }
            if (dowEl) {
                const dowVal = (Math.random() - 0.5) * 1.5;
                dowEl.textContent = formatPercent(dowVal);
                dowEl.className = dowVal >= 0 ? 'text-green-400' : 'text-red-400';
            }
        }

        // ==================== INITIALIZATION ====================
        function updateUI() {
            updateHeader();
            updateTicker();
            updateMarketOverview();
            updateTradingInterface();
            updatePositions();
            updateTradeHistory();
            updateOrderBook();
        }

        function cleanup() {
            // Clear all intervals on page unload
            updateIntervals.forEach(id => clearInterval(id));
            updateIntervals = [];
        }

        function init() {
            try {
                updateUI();
                initCharts();

                // Set up event listeners with error handling
                const quantityEl = document.getElementById('quantity');
                const limitPriceEl = document.getElementById('limitPrice');

                if (quantityEl) {
                    quantityEl.addEventListener('input', updateEstimatedTotal);
                    quantityEl.addEventListener('change', () => {
                        const val = parseInt(quantityEl.value);
                        if (val < 1) quantityEl.value = 1;
                        if (val > 100000) quantityEl.value = 100000;
                    });
                }
                if (limitPriceEl) {
                    limitPriceEl.addEventListener('input', updateEstimatedTotal);
                }

                // Keyboard navigation for asset selection
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        document.activeElement?.blur();
                    }
                });

                // Simulate price movements every 3 seconds
                updateIntervals.push(setInterval(simulatePriceMovements, 3000));

                // Update order book every 2 seconds
                updateIntervals.push(setInterval(updateOrderBook, 2000));

                // Cleanup on page unload
                window.addEventListener('beforeunload', cleanup);

                console.log('Wall Street Trading Simulator initialized successfully');
            } catch (e) {
                console.error('Error initializing app:', e);
                showToast('Error loading application. Please refresh the page.', 'error');
            }
        }

        // Start the app
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
